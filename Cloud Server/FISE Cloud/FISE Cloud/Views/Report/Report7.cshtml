@using FISE_Cloud.Models;
@using FISE_Cloud.Models.School;
@using Webdiyer.WebControls.Mvc;
@model Report7FilterModel
@{
    ViewBag.Title = Resource.Reports_Report7_Title;
    ViewBag.HeaderPageTitle = "Reports";
}
<style>
    
    .nav-tabs > li {
        width: 33.25%!important;
    }
    .field-validation-error {
        display:none;
        position:static;
    }
</style>
<div class="row title-section">
    <div>
        @if (Html.MvcSiteMap().SiteMap.CurrentNode != Html.MvcSiteMap().SiteMap.RootNode)
        {
            @Html.MvcSiteMap().SiteMapPath("BootstrapSiteMapPathHelperModel")
        }
    </div>

    <div class="col-xs-12">
        <h4 class="page-title">@Resource.Reports_Report7_Title <span id="selected-duration"></span>
            <a class="exporttoexcel" id="report7_exptoexcel" onclick="return ExportReport7();" title="@Resource.Export_Reports_Report7"></a>
        </h4>
    </div>
</div>
<hr />
@using (Html.BeginForm("ExportReport7", "Report", FormMethod.Post, new { id = "filter-selected-items-toexport-form" }))
{
    <input type="hidden" id="schoolidsexport" name="schoolidsexport" value="" />
    <input type="hidden" id="durationexport" name="durationexport" value="" />
    <input type="hidden" id="cityexport" name="cityexport" value="" />
    <input type="hidden" id="monthexport" name="monthexport" value="" />
    <input type="hidden" id="yearexport" name="yearexport" value="" />
}
@using (Ajax.BeginForm("Report7", "Report", null, new AjaxOptions { HttpMethod = "POST", UpdateTargetId = "data", OnBegin = "onBegin", OnComplete = "onComplete" }, new { id = "filterForm" }))
{
    <input type="hidden" name="type" value="all" />
    <input type="hidden" name="schoolids" id="schoolids" value="">

    <span id="modifyfilter_link" class="accordion_plus">@Resource.Reports_ModifyFiltersandRegenerateReport</span>
    <div id="filter_accordion" class="collapse in">
    <div class="row reportfilter-row">
        <div class="col-xs-12"><p class="report_subtitle">@Resource.Reports_SelectDuration</p></div>
        <div class="col-xs-12 reportfilter_radio">
            <div class="col-xs-2">
                <input type="radio" name="duration" value="a-month" dropdown="amonth" />
                <label class="report-radio-label">@Resource.Reports_SelectDuration_Amonth</label>
            </div>
            <div class="col-xs-2">
                @Html.DropDownList("year",
                Enumerable.Range(2010, DateTime.Now.Year + 1 - 2010).
                Select(i => new SelectListItem { Value = i.ToString(), Text = i.ToString() }),
                "Select Year", new { @class = "amonth", id = "myear" })
                <span class="report-error" data-valmsg-replace="true">@Resource.Report_YearReq_Error</span>
            </div>
            <div class="col-xs-offset-1 col-xs-2">
                @{IEnumerable<Month>
                month = Enum.GetValues(typeof(Month)).Cast<Month>();
                }
                @Html.DropDownList("month",
            month.Select(i => new SelectListItem { Value = ((int)i).ToString(), Text = i.ToString() }),
            "Select Month", new { @class = "amonth", id = "mmonth" })
                <span class="report-error" data-valmsg-replace="true">@Resource.Report_MonthReq_Error</span>
            </div>
        </div>
        <div class="col-xs-12 reportfilter_radio">
            <div class="col-xs-2">
                <input type="radio" name="duration" value="a-quarter" dropdown="aquarter" />
                <label class="report-radio-label">@Resource.Reports_SelectDuration_Aquarter</label>
            </div>
            <div class="col-xs-2">
                @Html.DropDownList("year",
                    Enumerable.Range(2010, DateTime.Now.Year + 1 - 2010).
                Select(i => new SelectListItem { Value = i.ToString(), Text = i.ToString() }),
         "Select Year", new { @class = "aquarter", id = "qyear" })
                <span class="report-error" data-valmsg-replace="true">@Resource.Report_YearReq_Error</span>
            </div>
            <div class="col-xs-offset-1 col-xs-2">
                @{IEnumerable<Quarter>
                quarter = Enum.GetValues(typeof(Quarter)).Cast<Quarter>();
                }

                @Html.DropDownList("month",
                quarter.
                Select(i => new SelectListItem { Value = ((int)i).ToString(), Text = i.ToString() }),
                "Select Month", new { @class = "aquarter", id = "qmonth" })
                <span class="report-error" data-valmsg-replace="true">@Resource.Report_MonthReq_Error</span>
            </div>
        </div>
        <div class="col-xs-12 reportfilter_radio">
            <div class="col-xs-2">
                <input type="radio" name="duration" value="a-year" dropdown="ayear" />
                <label class="report-radio-label">@Resource.Reports_SelectDuration_Ayear</label>
            </div>
            <div class="col-xs-2">
                @Html.DropDownList("year",
                Enumerable.Range(2010, DateTime.Now.Year + 1 - 2010).
                Select(i => new SelectListItem { Value = i.ToString(), Text = i.ToString() }),
                "Select Year", new { @class = "ayear", id = "ayear" })
                <span class="report-error" data-valmsg-replace="true">@Resource.Report_YearReq_Error</span>
            </div>
        </div>
        <div class="col-xs-12">
            <div class="col-xs-2">
                <input type="radio" name="duration" value="a-year-to-date" dropdown="tilldate" checked/>
                <label class="report-radio-label">@Resource.Reports_SelectDuration_Ayeartodate</label>
                <span class="field-validation-error">@Resource.Reports_SelectDuration_ValidationErrMsg</span>
            </div>
        </div>
    </div>

    <div class="row reportfilter-row">
        <div class="col-xs-2"><p class="report_subtitle">@Resource.Reports_SelectLocation</p></div>
        <div class="col-xs-2">
            @Html.DropDownList("city",
            Model.Cities.
            Select(i => new SelectListItem { Value = i.ToString(), Text = i.ToString() }),
            "All Cities")
        </div>
    </div>

    <div class="row reportfilter-row">
        <div class="col-xs-12"><p class="report_subtitle">@Resource.Reports_SelectSchools</p></div>
        <div class="col-xs-12">
            <div class="col-xs-12">
                <input type="checkbox" id="selectall_school" value="All" checked />
                <span class="filter_checkboxlabel2">@Resource.checkbox_SelectAll</span>
            </div>
            <hr class="hr_report" />
            @foreach (var item in Model.Schools)
            {
                <div class="col-xs-12 reportfilter_check school" city="@item.City.Replace(" ",string.Empty)">
                    <input type="checkbox" id="" name="SchoolIds" value="@item.SchoolId" chcity="@item.City.Replace(" ",string.Empty)" />
                    <span class="filter_checkboxlabel2">@item.SchoolName</span>
                </div>
            }
        </div>
        @if (Model.Schools.Count > 10)
        {
            <div class="col-xs-12 seeallschools">
                <a href="#">@Resource.Reports_link_Seeallschools</a>
            </div>
        }
    </div>

    <div class="buttons">
            <input id="btnsubmit" type="submit" class="btn btn-default btn-rect" value="@Resource.Reports_btn_GenerateReport" data-toggle="collapse" data-target="#filter_accordion" />
        </div>

    </div>
    <div id="data"></div>
}
@section scripts
{
    <script src="~/Scripts/jquery.unobtrusive-ajax.min.js?v=1"></script>
    <script>
        $(document).ready(function () {
            $('#data').hide();
            $('.school').slice(10, $('.school').length).hide();
            $('.ayear,.amonth,.aquarter').attr('disabled', true);

            $('#btnsubmit').click(function () {
                var result = true;
                if ($('[name$=duration]:checked').length == 0) {
                    $('span.field-validation-error').css('display', 'block');
                    $('html, body').animate({ scrollTop: 0 }, 500);
                    return false;
                }
                else {
                    var attr = $('[name$=duration]:checked').attr('dropdown');
                    $('.report-error').hide();
                    $('.' + attr).each(function () {
                        if ($(this).val() == '') {
                            $(this).siblings('.report-error').show();
                            result = false;
                            $('html, body').animate({ scrollTop: 0 }, 500);
                        }
                    });
                }
                if (result) {
                    var schoolids = [];
                    var city = $('#city').val();
                    if ($('#selectall_school').prop('checked')) {
                        $('#schoolids').val('');
                    }
                    else {
                        $('[name$=SchoolIds]:checked').each(function (index, value) {
                            schoolids.push($(this).val());
                        });
                    }
                    $('#schoolids').val(schoolids.join(','));
                }
                return result;
            });
        });

        $('.seeallschools').click(function () {
            var val = $('#city').val().replace(/ /g, '');
            $('.school').hide();
            if (val == '')
                $('.school').show();
            else
                $('[city$=' + val + ']').show();
            $(this).hide();
        });

        $('#city').change(function () {
            var val = $(this).val().replace(/ /g, '');
            $('.school').hide();
            if (val == '')
                $('.school').show();
            else {
                $('[city$=' + val + ']').show();
                $('.school [chcity!=' + val + ']').prop('checked', false);
            }
            $('#selectall_school').prop('checked', true);
            $('.seeallschools').hide();
        });

                $('[name$=duration]').click(function () {
                    $('.ayear,.amonth,.aquarter').attr('disabled', true);
                    $('.ayear,.amonth,.aquarter').css('opacity', 0.5);
                    $('.' + $(this).attr('dropdown')).attr('disabled', false);
                    $('.' + $(this).attr('dropdown')).css('opacity', 1);
                    $('span.field-validation-error').css('display', 'none');
                });

        var schools = []
        $(function () {
            $('#SchoolWiseSchool options:not(first)').each(function () {
                schools.push({ Id: $(this).val(), Name: $(this).text(), City: $(this).attr('city') });
            });
        });

        function SchoolWiseCityChange() {
            $('#SchoolWiseSchool option:not(:first)').each(function () {
                schools.push({ Id: $(this).val(), Name: $(this).text(), City: $(this).attr('city') });
            });
            $('#SchoolWiseSchool').attr('disabled', false);

            $('#SchoolWiseSchool').html('');
            $('#SchoolWiseSchool').append('<option value="">Select a school</option>')
            $.each(schools, function (index, value) {
                if (value.City == $('#SchoolWiseCity').val())
                    $('#SchoolWiseSchool').append('<option value="' + value.Id + '">' + value.Name + '</option>')
            });
        }

        function SchoolWiseSchoolChange(ctrl) {
            var attr = $('[name$=duration]:checked').attr('dropdown');
            var val = $('[name$=duration]:checked').val();
            var time = [{ time: '0' }, { time: '0' }]
            $('.' + attr).each(function (index, value) {
                time[index].time = $(this).val();
            });

            $("#divSchoolWise").load("/Report/Report7",
           { schoolids: $(ctrl).val(), duration: val, city: $('#SchoolWiseCity').val(), month: time[1].time, year: time[0].time, type: "school" });
        }

        function CityWiseCityChange(ctrl) {
            var attr = $('[name$=duration]:checked').attr('dropdown');
            var val = $('[name$=duration]:checked').val();
            var time = [{ time: '0' }, { time: '0' }]
            $('.' + attr).each(function (index, value) {
                time[index].time = $(this).val();
            });

            $("#divCityWise").load("/Report/Report7",
           { schoolids: $('#schoolids').val(), duration: val, city: $(ctrl).val(), month: time[1].time, year: time[0].time, type: "city" });
        }

        $('#selectall_school').click(function () {
            if ($(this).prop('checked')) {
                var val = $('#city').val().replace(/ /g, '');
                if (val == '')
                    $('[name=SchoolIds]').prop('checked', false);
                else
                    $('[city=' + val + ']').prop('checked', false);
            }
        });

        $('[name=SchoolIds]').click(function () {
            var val = $('#city').val().replace(/ /g, '');
            if (val == '') {
                if ($('[name=SchoolIds]').length == $('[name=SchoolIds]:checked').length) {
                    $('[name=SchoolIds]').prop('checked', false);
                    $('#selectall_school').prop('checked', true);
                }
                else if ($('[name=SchoolIds]:checked').length == 0)
                    $('#selectall_school').prop('checked', true);
                else {
                    $('#selectall_school').prop('checked', false);
                }
            }
            else {
                if ($('[chcity=' + val + ']').length == $('[chcity=' + val + ']:checked').length) {
                    $('[chcity=' + val + ']').prop('checked', false);
                    $('#selectall_school').prop('checked', true);
                }
                else if ($('[name=SchoolIds]:checked').length == 0)
                    $('#selectall_school').prop('checked', true);
                else {
                    $('#selectall_school').prop('checked', false);
                }
            }
        });

        function ExportReport7() {
            var attr = $('[name$=duration]:checked').attr('dropdown');
            var val = $('[name$=duration]:checked').val();
            var time = [{ time: '0' }, { time: '0' }]
            $('.' + attr).each(function (index, value) {
                time[index].time = $(this).val();
            });

            $('#durationexport').val(val);
            $('#schoolidsexport').val($('#schoolids').val());
            $('#monthexport').val(time[1].time);
            $('#yearexport').val(time[0].time);
            $('#cityexport').val($('#city').val());
            $('#filter-selected-items-toexport-form').submit();
            return false;
        }
        var report_Timeline = "";
            $('#filter_accordion').on('hidden.bs.collapse', function () {
                $('span#modifyfilter_link').show();
                $('#data').show();
                $('#filter_accordion').hide();
                    $('#filter_result').show();
                    $('#report7_exptoexcel').css('display', 'inline-flex');
                    var attr = $('[name$=duration]:checked').attr('dropdown');
                    if (attr == "amonth")
                        report_Timeline = "For " + $('#mmonth').children(':selected').text().substring(0,3) + " " + $('#myear').val().toString();
                    else if (attr == "aquarter") {
                        var quarter = $('#qmonth').children(':selected').text();
                        var Q = 0;
                        if (quarter.toLowerCase() == "first") { Q = 1; } else if (quarter.toLowerCase() == "second") { Q = 2; } else if (quarter.toLowerCase() == "third") { Q = 3; } else if (quarter.toLowerCase() == "fourth") { Q = 4; }
                        report_Timeline = "For Q" + Q + " " + $('#qyear').val().toString();
                    }
                    else if (attr == "ayear")
                        report_Timeline = "For " + $('#ayear').val().toString();
                    else if (attr == "tilldate")
                        report_Timeline = "For " + "@Resource.Reports_Ayeartodate";
                    $("span#selected-duration").html("");
                    $("span#selected-duration").html(report_Timeline);
                });

                $('span#modifyfilter_link').click(function () {
                    $('span#modifyfilter_link').hide();
                    $('#filter_accordion').addClass("in");
                    $('#filter_accordion').css('height', 'auto');
                    $('#filter_accordion').show();
                });
                function onBegin() {
                    displayAjaxLoading(true);
                }
                function onComplete(jqXHR, textStatus, err) {
                   
                    if (jqXHR.status == 401) {
                        //refresh the page, as we are not longer authorized
                        location.reload();
                    }
                    displayAjaxLoading(false);
                    $('html, body').animate({ scrollTop: 0 }, 500);
                }
    </script>
}