@using FISE_Cloud.Models.School
@using FISE_Cloud.Models
@model StudentandParentInfo
@{
    ViewBag.Title = "Student and Parent Info";
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.HeaderPageTitle = "Schools";
}
@{
    var SchoolUId = ViewContext.RouteData.Values["schooluid"];
}
<div class="row title-section">
    <div>
        @if (Html.MvcSiteMap().SiteMap.CurrentNode != Html.MvcSiteMap().SiteMap.RootNode)
        {
            @Html.MvcSiteMap().SiteMapPath("BootstrapSiteMapPathHelperModel")
        }
    </div>
    <h4 class="page-title">@Model.FirstName @Model.LastName</h4>
    <div class="float-right"><h4 class="role-title">@Resource.Studentandparentinfo_student</h4></div>
    <div class="popup_background"></div>
    <div id="partialview">
        <div class="form-group">
            <div id="divclose" onclick="return ClosePoUp()">X</div>
        </div>

        <h5 class="page-title">@Resource.Btn_ResendRegistrationMail</h5>
        <hr>
        <div class="popup-desc" id="popupdesc1">@Resource.ResendEmailMessage1  <span id="lastsenddate"></span></div>
        <div class="popup-desc" id="popupdesc2">@Resource.ResendEmailMessage2&nbsp;@Resource.Btn_ResendRegistrationMail.ToLower()?</div>
        <div class="form-group buttons" style="margin-top:10px;">
            <a class="btn btn-default btn-rect" onclick="resenduserregmail(@Model.ParentDetails.UserId)">YES</a>
            <a class="btn btn-default btn-rect" onclick="return ClosePoUp();">NO</a>
        </div>

    </div>
</div>
    <hr />

    <div class="form-horizontal">

        @Html.HiddenFor(model => model.UserId)
        <div class="form-group">

            @Html.LabelFor(model => model.FirstName, "First Name:", htmlAttributes: new { @class = "control-label col-xs-3" })
            <span class="col-xs-9 control-label">
                @Html.DisplayFor(model => model.FirstName)
            </span>
        </div>
        <div class="form-group">
            @Html.LabelFor(model => model.LastName, "Last Name:", htmlAttributes: new { @class = "control-label col-xs-3" })
            <span class="col-xs-9 control-label">
                @Html.DisplayFor(model => model.LastName)

            </span>
        </div>
        <div class="form-group">
            @Html.LabelFor(model => model.Grade, "Grade:", htmlAttributes: new { @class = "control-label col-xs-3" })
            <span class="col-xs-9 control-label">
                @Html.DisplayFor(model => model.Grade)
            </span>
        </div>
        <div class="form-group">
            @Html.LabelFor(model => model.SubSection,"Section:", htmlAttributes: new { @class = "control-label col-xs-3" })
            <span class="col-xs-9 control-label">
                @Html.DisplayFor(model => model.SubSection)
            </span>
        </div>        
        <div class="form-group">
            @Html.LabelFor(model => model.Gender, "Gender:", htmlAttributes: new { @class = "control-label col-xs-3" })
            <span class="col-xs-9 control-label">
                @Html.DisplayFor(model => model.Gender)
            </span>
        </div>
        <div class="form-group">
            @Html.LabelFor(model => model.DateOfBirth, "Date Of Birth:", htmlAttributes: new { @class = "control-label col-xs-3" })
            <span class="col-xs-9 control-label">
                @(string.IsNullOrWhiteSpace(Model.DateOfBirth.ToString()) ? "--" : string.Format("{0:dd.MM.yyyy}", Model.DateOfBirth))
            </span>
        </div>
        <div class="form-group">
            @Html.LabelFor(model => model.CreationDate, "Creation Date:", htmlAttributes: new { @class = "control-label col-xs-3" })
            <span class="col-xs-9 control-label">
                @Model.CreationDate.ToString("dd.MM.yyyy")
            </span>
        </div>
        <div class="form-group">
            @Html.LabelFor(model => model.RegistrationDate, "Registration Date:", htmlAttributes: new { @class = "control-label col-xs-3" })
            <span class="col-xs-9 control-label">
                @(string.IsNullOrWhiteSpace(Model.RegistrationDate.ToString()) ? "--" : string.Format("{0:dd.MM.yyyy}", Model.RegistrationDate))
            </span>
        </div>
        <div class="form-group">
            @Html.LabelFor(model => model.Status, "Status:", htmlAttributes: new { @class = "control-label col-xs-3" })
            <span class="col-xs-9 control-label">
                @if (!(Model.Status) && Model.IsTrashed)
                {
                    @Html.Raw(Resource.Status_Disabled);
                }
                else if (Model.Status && !(Model.IsTrashed) && Model.LastLoginDate != null)
                {
                    @Html.Raw(Resource.Status_Active);
                }
                else if (Model.Status && !(Model.IsTrashed) && Model.LastLoginDate == null)
                {
                    @Html.Raw(Resource.Status_Registered);
                }
                else if (!(Model.Status) && !(Model.IsTrashed) && Model.LastLoginDate == null)
                {
                    @Html.Raw(Resource.Status_Created);
                }

            </span>
        </div>
        <div class="form-group">
            @Html.LabelFor(model => model.SubscriptionStartDate, "Subscription Start Date:", htmlAttributes: new { @class = "control-label col-xs-3" })
            <span class="col-xs-9 control-label">
                @(string.IsNullOrWhiteSpace(Model.SubscriptionStartDate.ToString()) ? "--" : string.Format("{0:dd.MM.yyyy}", Model.SubscriptionStartDate))
            </span>
        </div>

        <div class="form-group">
            @Html.LabelFor(model => model.SubscriptionEndDate, "Subscription End Date:", htmlAttributes: new { @class = "control-label col-xs-3" })
            <span class="col-xs-9 control-label">
                @(string.IsNullOrWhiteSpace(Model.SubscriptionEndDate.ToString()) ? "--" : string.Format("{0:dd.MM.yyyy}", Model.SubscriptionEndDate))

            </span>
        </div>
        <div class="form-group">
            @Html.LabelFor(model => model.Username, "UserName:", htmlAttributes: new { @class = "control-label col-xs-3" })
            <span class="col-xs-9 control-label">
                @Html.DisplayFor(model => model.Username)

            </span>
        </div>
        

        <div class="form-group">
            @Html.LabelFor(model => model.HomeDevices, "Active Home Devices:", htmlAttributes: new { @class = "control-label col-xs-3" })
            <span class="col-xs-9 control-label">
                @Html.DisplayFor(model => model.HomeDevices)
            </span>
        </div>
        <div class="col-xs-offset-3 buttons">
            @if (Model.Status || Model.IsTrashed)
            { 
            <a  class="btn btn-default btn-rect" name="edit"  onclick="window.location.href = '@Url.RouteUrl("EditStudent", new { schooluid = @Model.SchoolUId, studentid = @Model.UserId })';"> @Resource.Btn_Modify</a>
                if (!Model.SchoolStatus)
                { 
                <input type="submit" id="disable-student" class="btn btn-default btn-rect" name="remove" value="@(Model.IsTrashed ? @Resource.Btn_Enable : @Resource.Btn_Disable)" onclick="confirmDisable(@Model.UserId, this.id)" />
                }
            }
            @{TempData["userid"] = Model.UserId;}
        </div>
    </div>



    <div id="divPartial">
        @Html.Partial("~/Views/School/_ParentInfo.cshtml", Model)
    </div>
    @if (Model.Students != null && Model.Students.Count>0)
    {
        <div class="space-bottom">
                <span> &nbsp;@Resource.Note_ParentAccountAssocWithStudentAccount @*@(Model.Students.Count) more student(s).*@</span>            
        </div>
        <div class="row">
        @foreach (StudentRegistrationModel student in Model.Students)
        {
            <a class="a_link_list-item" href="@Url.RouteUrl("StudentandParentInfo", new { schooluid =SchoolUId, studentid=student.UserId})">
                <div class="row list-item">
                    <div class="col-xs-12 list-item-name">@student.FirstName @student.LastName</div>

                    <div class="col-xs-12">
                        <span class="list-item-subcontent"><span class="list_content_subdiv_bold">@Resource.School_Studentlist_ParentEmail</span><span>@student.Email</span></span>
                        <span class="list-item-subcontent">
                            <span class="list_content_subdiv_bold">@Resource.School_Studentlist_SubStarts</span><span>
                                @(string.IsNullOrWhiteSpace(student.SubscriptionStartDate.ToString()) ? "--" : string.Format("{0:dd.MM.yyyy}", student.SubscriptionStartDate))
                            </span>
                        </span>
                        <span class="list-item-subcontent">
                            <span class="list_content_subdiv_bold">@Resource.School_Studentlist_SubEnds</span><span>
                                @(string.IsNullOrWhiteSpace(student.SubscriptionEndDate.ToString()) ? "--" : string.Format("{0:dd.MM.yyyy}", student.SubscriptionEndDate))
                            </span>
                        </span>
                        <span class="float-right list_content_subdiv_bold">
                            @if (!(@student.Status) && @student.IsTrashed)
                            {
                                @Html.Raw(Resource.Status_Disabled);
                            }
                            else if (@student.Status && !(@student.IsTrashed) && (@student.LastLoginDate) != null)
                            {
                                @Html.Raw(Resource.Status_Active);
                            }
                            else if (@student.Status && !(@student.IsTrashed) && (@student.LastLoginDate) == null)
                            {
                                @Html.Raw(Resource.Status_Registered);
                            }
                            else if (!@student.Status && !@student.IsTrashed && (@student.LastLoginDate) == null)
                            {
                                @Html.Raw(Resource.Status_Created);
                            }                            
                        </span>

                    </div>


                </div>
            </a>
        }
        </div>
    }

@section scripts {  
    <script type="text/javascript">
        function ClosePoUp() {
            $('#partialview').hide();
            $('.popup_background').css('display', 'none');
            return false;
        }
        function OpenPopUp(UserId) {
            $.ajax({
                url: '@Url.Action("GetLastEmailSendDate", "School")?UserId=' + UserId + '&Type=ParentRegistration',
                type: 'Get',
                async: false,
                success: function (result) {
                    if (result == '') {
                        $('#popupdesc1').hide();
                    }
                    else {
                        $('#lastsenddate').text(result);
                        $('#popupdesc1').show();
                    }
                    $('#partialview').show().css('top', $(window).height()/2+50+'px');
                    $('.popup_background').css('display', 'block');
                },
                error: function (jqXHR, textStatus, err) {
                    if (jqXHR.status == 401) {
                        location.reload();
                    }
                }
            });
        }
        function confirmDisable(userId, elemid) {          
            var status = false;
            jsondata = { "userid" : userId };
            
            if ($("#" + elemid).val().toLowerCase() == "disable") {
                var result = confirm("@Resource.Disable_ConfirmMsg");
            }
            else {
                var result = confirm("@Resource.Enable_ConfirmMsg");
            }
            if (result) {
                $.ajax({
                    url: '@Url.Action("DisableParentStudent", "School")',
                    type: 'POST',
                    async: false,
                    data: jsondata,
                    dataType: 'json',
                    success: function (result) {
                        if (result.Status === true) {
                            status = true;
                            window.location.href = window.location.href;
                        }
                    },
                    error: function (jqXHR, textStatus, err) {
                        if (jqXHR.status == 401) {
                            //refresh the page, as we are not longer authorized
                            location.reload();
                        }
                    }
                });
                return status;
            }
            else {
                return false;
            }
        }
        function resenduserregmail(userid) {
            jsondata = { "userid": userid };
            $.ajax({
                url: '@Url.Action("ResendUserRegistrationMail", "School")',
                type: 'POST',
                async: false,
                data: jsondata,
                dataType: 'json',
                success: function (result) {
                    ClosePoUp();
                    if (result.Status == 1 || result.Status == 2) {
                        alert("@Resource.RegistrationMail_Success");
                    }
                    else if (result.Status == 3) {
                        alert("@Resource.RegistrationMail_NoUser");
                    }
                    else {
                        alert("@Resource.RegistrationMail_ErrorMailNotSent");
                    }
                },
                error: function (jqXHR, textStatus, err) {
                    if (jqXHR.status == 401) {
                        //refresh the page, as we are not longer authorized
                        location.reload();
                    }
                }
            });
        }

        
    </script>
}

<style>
    #popupdesc1 {
        padding: 12px 0;
    }

    #partialview {
        border: solid;
    }

    table td, table th {
        min-width: 100px;
        border: solid 1px black;
    }

    #partialview {
        border: none;
        z-index: 99999;
        position: absolute;
        background: white;
        opacity: 1;
        top: 13%;
        /*left: 31%;*/ left: 30%;
        padding: 10px 40px;
        display: none;
        width: 380px;
        font-size: 14px;
        font-family: Roboto-Regular;
        display: none;
    }

    .modal1 {
        position: fixed;
        font-family: Arial, Helvetica, sans-serif;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        background: rgba(0,0,0,0.8);
        z-index: 99999;
        opacity: 0;
        -webkit-transition: opacity 400ms ease-in;
        -moz-transition: opacity 400ms ease-in;
        transition: opacity 400ms ease-in;
        pointer-events: none;
    }

    #divclose {
        float: right;
        cursor: pointer;
        color: #FC654C;
        width: 4px;
        font-size: 30px;
    }

    .popup-desc {
        margin-top: -8px;
        font-size: 14px;
    }
</style>